<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Making (?:things|code|evil|mistakes)."><meta name=author content="Marcus Ramberg"><meta name=generator content="Hugo 0.72.0"><title>Painless rollouts with FCGI::Engine -- Suburban Nerd</title><link href=https://marcus.nordaaker.com/css/bootstrap.min.css rel=stylesheet><link href=https://marcus.nordaaker.com/css/clean-blog.min.css rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><meta property="og:title" content="Painless rollouts with FCGI::Engine"><meta property="og:url" content="https://marcus.nordaaker.com/"><meta property="og:image" content="https://marcus.nordaaker.com/"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://marcus.nordaaker.com>Suburban Nerd</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/post/>Archives</a></li></ul></div></div></nav><header class=intro-header style="background-image:linear-gradient( rgba(0,0,0,0.5),rgba(0,0,0,0.5) ),url('https://marcus.nordaaker.com/img/post-bg.jpg')"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Painless rollouts with FCGI::Engine</h1><h2 class=subheading></h2><span class=meta>A 2 minute read,
<small>2009-02-24</small>
&minus; &#127991;
<a class=tag href=/tags/catalyst>catalyst</a>
&#127991;
<a class=tag href=/tags/iusethis>iusethis</a>
&#127991;
<a class=tag href=/tags/perl>perl</a></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p>Our software site <a href=http://iusethis.com/>i use this</a> is built on the MVC Framework <a href=http://catalyst.perl.org/>Catalyst</a>. We currently run it using the Russian web server <a href=http://wiki.codemongers.com/Main>Nginx</a> and standalone fastcgi servers. I am using the Moose based <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/>CGI::Engine</a> distribution by Stevan Little to start the servers. This module makes it really easy to manage your applications. You just create a YML config file like this:</p><pre>
---
- name: "iusethis-osx.server"
  nproc: 4
  scriptname: "/www/iusethis-osx/script/iusethis_fastcgi.pl"
  pidfile: "/var/run/iusethis-osx.pid"
  socket: "/var/run/iusethis-osx.sock" 
</pre><p>with an entry for each server you want to run. (Note that the paths has been changed to protect the innocent.) Then you just create a simple perl script (See the <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/lib/FCGI/Engine/Manager.pm>FCGI::Engine::Manager SYNOPSIS</a> for a sample), and you can easily start, stop and check the status for each application individually or every application in your config. If you have a system v style init, you can just stick the script in /etc/init.d/ and it will behave just like any of your other startup scripts.</p><p>There is one annoying detail. Each time you roll out code, you have to restart your fastcgi processes. Since Catalyst takes some time to initialize, the application is down, and end users gets 500 Internal Server Error responses, unless you have a load balancer in front and take the node out of the cluster before upgrading. It does not have to work like this. Since the fcgi workers use a non-exclusive lock on the socket, you can start a new set of processes before you kill the old ones. this way, no requests are lost.</p><p>I really wanted this feature, so I have spent some time today hacking on FCGI::Engine. Stevan accepted my patches, and released version <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/>0.06</a>, which supports this restart mode, via a new 'graceful' method added to FCGI::Engine::Manager + some bug fixes. Nginx already support <a href=http://wiki.codemongers.com/NginxCommandLine#utnbotf>On the fly upgrades</a>, which means there is no need for us to drop a user connection when rolling out new code again.</p></div></div></div></article><hr><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:marcusramberg@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.facebook.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Code released under the Apache 2.0 license.</p></div></div></div></footer><script src=https://marcus.nordaaker.com/js/jquery.min.js></script><script src=https://marcus.nordaaker.com/js/bootstrap.min.js></script></body></html>