<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=description content><meta name=generator content="Hugo 0.72.0"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css type=text/css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type=text/css><link rel=alternate href=/index.xml type=application/rss+xml title="Suburban Nerd"><title>Painless rollouts with FCGI::Engine - Suburban Nerd</title></head><body><header><div class="container clearfix"><a class=path href=http://marcus.nordaaker.com>[Suburban Nerd]</a>
<span class=caret># _</span><div class=right></div></div></header><div class=container><main role=main class=article><article class=single itemscope itemtype=http://schema.org/BlogPosting><div class=meta><span class=key>published on</span>
<span class=val><time itemprop=datePublished datetime=2009-02-24>February 24, 2009</time></span><br><span class=key>tags:</span>
<span class=val><a href=/tags/catalyst>Catalyst</a>
<a href=/tags/iusethis>iusethis</a>
<a href=/tags/perl>Perl</a></span></div><h1 class=headline itemprop=headline>Painless rollouts with FCGI::Engine</h1><section class=body itemprop=articleBody><p>Our software site <a href=http://iusethis.com/>i use this</a> is built on the MVC Framework <a href=http://catalyst.perl.org/>Catalyst</a>. We currently run it using the Russian web server <a href=http://wiki.codemongers.com/Main>Nginx</a> and standalone fastcgi servers. I am using the Moose based <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/>CGI::Engine</a> distribution by Stevan Little to start the servers. This module makes it really easy to manage your applications. You just create a YML config file like this:</p><pre>
---
- name: "iusethis-osx.server"
  nproc: 4
  scriptname: "/www/iusethis-osx/script/iusethis_fastcgi.pl"
  pidfile: "/var/run/iusethis-osx.pid"
  socket: "/var/run/iusethis-osx.sock" 
</pre><p>with an entry for each server you want to run. (Note that the paths has been changed to protect the innocent.) Then you just create a simple perl script (See the <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/lib/FCGI/Engine/Manager.pm>FCGI::Engine::Manager SYNOPSIS</a> for a sample), and you can easily start, stop and check the status for each application individually or every application in your config. If you have a system v style init, you can just stick the script in /etc/init.d/ and it will behave just like any of your other startup scripts.</p><p>There is one annoying detail. Each time you roll out code, you have to restart your fastcgi processes. Since Catalyst takes some time to initialize, the application is down, and end users gets 500 Internal Server Error responses, unless you have a load balancer in front and take the node out of the cluster before upgrading. It does not have to work like this. Since the fcgi workers use a non-exclusive lock on the socket, you can start a new set of processes before you kill the old ones. this way, no requests are lost.</p><p>I really wanted this feature, so I have spent some time today hacking on FCGI::Engine. Stevan accepted my patches, and released version <a href=http://search.cpan.org/~stevan/FCGI-Engine-0.06/>0.06</a>, which supports this restart mode, via a new 'graceful' method added to FCGI::Engine::Manager + some bug fixes. Nginx already support <a href=http://wiki.codemongers.com/NginxCommandLine#utnbotf>On the fly upgrades</a>, which means there is no need for us to drop a user connection when rolling out new code again.</p></section></article></main></div><footer><div class=container><span class=copyright>&copy; 2020 Suburban Nerd - <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a></span></div></footer></body></html>