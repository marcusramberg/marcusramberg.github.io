<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Making (things|code|mischief|mistakes)."><meta name=author content="[Marcus Ramberg]"><meta name=generator content="Hugo 0.72.0"><title>How I'm running Home Assistant in docker on NixOS -- marcus</title><link href=https://marcus.means.no//css/bootstrap.min.css rel=stylesheet><link href=https://marcus.means.no//css/clean-blog.min.css rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet type=text/css><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><meta property="og:title" content="How I'm running Home Assistant in docker on NixOS"><meta property="og:url" content="https://marcus.means.no//"><meta property="og:image" content="https://marcus.means.no//"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://marcus.means.no/>marcus</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/tags/>Tags</a></li><li><a href=/post/>Archives</a></li></ul></div></div></nav><header class=intro-header style="background-image:linear-gradient( rgba(0,0,0,0.5),rgba(0,0,0,0.5) ),url('https://marcus.means.no//img/post-bg.jpg')"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>How I'm running Home Assistant in docker on NixOS</h1><h2 class=subheading></h2><span class=meta><small>2020-07-19</small>
&minus; &#127991;
<a class=tag href=/tags/homeautomation>homeautomation</a>
&#127991;
<a class=tag href=/tags/nix>nix</a></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p>For the last few years I&rsquo;ve been into home automation, and since I buy random stuff from different vendors and with various protocols, I use <a href=https://home-assistant.io/>Home Assistant</a> to tie it all together. My main home server is a NixOS box, but for a long while I was running home assistant on my old Arch mac mini, because it was such a chore to handle dependencies with the NixOS home assistant service.</p><p>Typically home assistant just installs what you need on the fly, but with the nixos version you need to declare everything manually. However, this winter I migrated over to running NixOS in a docker container declaratively. Recent nixos has gained support for running these containers in systemd.</p><p>Setting this up is really easy</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>    docker-containers<span style=color:#f92672>.</span>hass <span style=color:#960050;background-color:#1e0010>=</span> {
      image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;homeassistant/home-assistant:0.112.4&#34;</span>;
      environment <span style=color:#f92672>=</span> { TZ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Europe/Oslo&#34;</span>; };
      extraDockerOptions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;--net=host&#34;</span> <span style=color:#e6db74>&#34;--device=/dev/serial/by-id/usb-0658_0200-if00&#34;</span>];
      volumes <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;/var/lib/homeassistant:/config&#34;</span> ];
    };
</code></pre></div><p>Here I&rsquo;m using the official image, and also demonstrating how to set extra docker options, like host networking or forwarding a usb device.</p><p>Nixos also provides other commonly used services natively as nix services.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>    services<span style=color:#f92672>.</span>influxdb<span style=color:#f92672>.</span>enable <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>;
    services<span style=color:#f92672>.</span>mosquitto <span style=color:#960050;background-color:#1e0010>=</span> {
      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>;
      users <span style=color:#f92672>=</span> { hass <span style=color:#f92672>=</span> {acl <span style=color:#f92672>=</span> [ <span style=color:#e6db74>&#34;topic readwrite #&#34;</span> ]; password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;notmypassword&#34;</span>; }; };
      extraConf <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;log_type debug&#34;</span>;
    };
</code></pre></div><p>Now you can also easily upgrade your install by changing the docker image version and doing <code>nixos-rebuild switch</code></p></div></div></div></article><hr><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:marcus@means.no><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted"><a href=https://github.com/marcusramberg/blog/>Code released under the Apache 2.0 license.</a></p></div></div></div></footer><script src=https://marcus.means.no//js/jquery.min.js></script><script src=https://marcus.means.no//js/bootstrap.min.js></script></body></html>