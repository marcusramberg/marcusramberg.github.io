<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Making (things|code|mischief|mistakes)."><meta name=author content="[Marcus Ramberg]"><meta name=generator content="Hugo 0.111.3"><title>Coturn for WebRTC NAT Traversal -- marcus</title><link href=https://marcus.means.no//css/bootstrap.min.css rel=stylesheet><link href=https://marcus.means.no//css/clean-blog.min.css rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin=anonymous referrerpolicy=no-referrer><link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel=stylesheet type=text/css><link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel=stylesheet type=text/css><meta property="og:title" content="Coturn for WebRTC NAT Traversal"><meta property="og:url" content="https://marcus.means.no//"><meta property="og:image" content="https://marcus.means.no//"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://marcus.means.no/>marcus</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/tags/>Tags</a></li><li><a href=/post/>Archives</a></li></ul></div></div></nav><header class=intro-header style="background-image:linear-gradient( rgba(0,0,0,.5),rgba(0,0,0,.5) ),url(https://marcus.means.no//img/post-bg.jpg)"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Coturn for WebRTC NAT Traversal</h1><h2 class=subheading></h2><span class=meta><small>2020-06-13</small>
&minus; &#127991;
<a class=tag href=/tags/perl>perl</a>
&#127991;
<a class=tag href=/tags/convos>convos</a></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p>This article will show you how to set up <a href=https://github.com/coturn/coturn>Coturn</a>. This is a service that allows
hosts behind NAT to communicate peer to peer with WebRTC. STUN is helping to negotiate port/ip and TURN will proxy the
actual traffic if all else fails.</p><p>We&rsquo;re using this with <a href=https://convos.chat/>Convos</a>&rsquo; video IRC feature, but the same applies to other WebRTC projects.</p><h2 id=installation>Installation</h2><p>I&rsquo;ll be assuming you&rsquo;re on Ubuntu for this tutorial, so users on other distros will have to adjust the setup for
their environment. First we&rsquo;ll install the actual ubuntu package. If you don&rsquo;t already have it, you will also need
letsencrypt to generate valid SSL certs.</p><div class=code><div></div><p>apt-install coturn certbot</p></div><p>Then we edit <code>/etc/turnserver.conf</code> - It should look roughly like this:</p><div class=code><div></div><p>listening-port=3478
tls-listening-port=5349</p><p>listening-ip=<server public interface>
relay-ip=<ip used for relaying>
external-ip=<actual external ip></p><p>realm=example.org
server-name=coturn.example.org</p><p>fingerprint
lt-cred-mech</p><p>user username:pass</p><p>cert=/etc/letsencrypt/live/coturn.example.org/fullchain.pem
pkey=/etc/letsencrypt/live/coturn.example.org/privkey.pem
cipher-list=&ldquo;ECDH+AESGCM:ECDH+CHACHA20:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS&rdquo;</p></div><h2 id=set-up-letsencrypt-dot>Set up letsencrypt.</h2><div class=code><div></div><p>$ sudo certbot certonly &ndash;standalone &ndash;preferred-challenges http \
&ndash;deploy-hook &ldquo;systemctl restart coturn&rdquo; \
-d coturn.example.com</p></div><p>certbot will automatically set up renewal of the certificate</p><p>Now let&rsquo;s enable the service. Add <code>TURNSERVER_ENABLED=1</code> to /etc/default/coturn and then
<code>systemctl start coturn</code></p><h2 id=convos-configuration>Convos configuration</h2><p>To use such a server with Convos, it requires a couple of environment variables to be set:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#a6e22e>Environment</span><span style=color:#f92672>=</span><span style=color:#e6db74>CONVOS\_STUN=stun://user:&lt;pass@coturn.example.&gt;&lt;5349&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Environment</span><span style=color:#f92672>=</span><span style=color:#e6db74>CONVOS\_TURN=turn://user:&lt;pass@coturn.example.&gt;&lt;5349&gt;</span>
</span></span></code></pre></div><p>(Assuming you run Convos under systemd)</p><p>Remember to <code>systemctl daemon-reload</code> and <code>restart</code> after updating the service :)</p><p>If you&rsquo;re running convos a different way like under <a href=https://convos.chat/doc/start#docker>Docker</a>, adjust the relevant settings.</p><script src=https://giscus.app/client.js data-repo=marcusramberg/blog data-repo-id="MDEwOlJlcG9zaXRvcnkyNzAwODc0ODA=" data-category=Announcements data-category-id=DIC_kwDOEBk1OM4CVAZX data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=transparent_dark data-lang=en crossorigin=anonymous async></script></div></div></div></article><hr><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:marcus@means.no><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-regular fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a rel=me href=https://hachyderm.io/@marcus><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-brands fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a rel=me href=https://github.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-brands fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted"><a href=https://github.com/marcusramberg/blog/>Code released under the MIT license.</a></p></div></div></div></footer><script src=https://marcus.means.no//js/jquery.min.js></script>
<script src=https://marcus.means.no//js/bootstrap.min.js></script></body></html>