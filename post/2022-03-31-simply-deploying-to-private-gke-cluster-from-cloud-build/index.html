<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Making (things|code|mischief|mistakes)."><meta name=author content="[Marcus Ramberg]"><meta name=generator content="Hugo 0.111.3"><title>Simply deploying to private GKE cluster from Cloud Build -- marcus</title><link href=https://marcus.means.no//css/bootstrap.min.css rel=stylesheet><link href=https://marcus.means.no//css/clean-blog.min.css rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin=anonymous referrerpolicy=no-referrer><link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel=stylesheet type=text/css><link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel=stylesheet type=text/css><meta property="og:title" content="Simply deploying to private GKE cluster from Cloud Build"><meta property="og:url" content="https://marcus.means.no//"><meta property="og:image" content="https://marcus.means.no//"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://marcus.means.no/>marcus</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/tags/>Tags</a></li><li><a href=/post/>Archives</a></li></ul></div></div></nav><header class=intro-header style="background-image:linear-gradient( rgba(0,0,0,.5),rgba(0,0,0,.5) ),url(https://marcus.means.no//img/post-bg.jpg)"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Simply deploying to private GKE cluster from Cloud Build</h1><h2 class=subheading></h2><span class=meta><small>2022-03-31</small>
&minus; &#127991;
<a class=tag href=/tags/devops>devops</a></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p>I recently came back to Google&rsquo;s Cloud Platform after some years on other cloud platforms, and as part of my work
there I had the requirement to setup a secure GCP cluster for some workloads. Google engineers have provided a nice
blueprint for this using a <a href="https://registry.terraform.io/modules/terraform-google-modules/kubernetes-engine/google/latest/examples/safer_cluster_iap_bastion?tab=outputs">IAP Proxy Bastion host for external
access</a>,
which works well for safe access from developer machines and allows you to limit Identity Aware Proxy access by GCP
Security Groups.</p><p>Basically you establish a IAP ssh tunnel to a Tinyproxy running on the bastion host, and then
set the proxy in your kube config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl config set clusters.$context_name.proxy-url http://localhost:8888
</span></span></code></pre></div><p>Of course, we also wanted to deploy to the cluster in an automated fashion, and as Cloud Build already was the CI of
choice, I set out to reach the cluster from there. Luckily Google has somewhat recently added support for <a href=https://globalcloudplatforms.com/2021/08/17/introducing-cloud-build-private-pools-secure-ci-cd-for-private-networks/>private
worker
pools</a>
so in theory this should be easy. However we hit a snag. Because the workers aren&rsquo;t actually running inside your VPC
and neither is the Kubernetes engine control plane, there&rsquo;s a restriction on transient VPC traffic. Google
Architecture Center provides a workaround using <a href=https://cloud.google.com/architecture/accessing-private-gke-clusters-with-cloud-build-private-pools>HA VPNs and separate
VPCs</a>, but I
found this to be a convoluted setup, and was worrying about maintaining a BGP routed VPN tunnel inside a single Google project.</p><p>After digging a bit, I found a much simpler solution. Since we already have a proxy on the Bastion host, you can
simply extend it to support traffic from the builder internal network range as well. We have to add the allowed range
to Tinyproxy in the startup script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span>{<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>cidr</span> <span style=color:#66d9ef>in</span> var.<span style=color:#a6e22e>bastion_allowed_ranges</span>}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;Allow </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cidr</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>etc</span><span style=color:#f92672>/</span><span style=color:#a6e22e>tinyproxy</span><span style=color:#f92672>/</span><span style=color:#a6e22e>tinyproxy</span>.<span style=color:#a6e22e>conf</span>
</span></span><span style=display:flex><span><span style=color:#f92672>%</span>{<span style=color:#a6e22e>endfor</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>systemctl</span> <span style=color:#a6e22e>restart</span> <span style=color:#a6e22e>tinyproxy</span>
</span></span></code></pre></div><p>And also add a firewall policy for the provided range(s):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_firewall&#34;</span> <span style=color:#e6db74>&#34;allow_bastion&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>count</span>   = length(var.<span style=color:#a6e22e>bastion_allowed_ranges</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>    = <span style=color:#e6db74>&#34;allow-bastion-proxy&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span> = module.<span style=color:#a6e22e>vpc</span>.<span style=color:#a6e22e>network_self_link</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>project</span> = module.<span style=color:#a6e22e>enabled_google_apis</span>.<span style=color:#a6e22e>project_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allow</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>protocol</span> = <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ports</span>    = [<span style=color:#e6db74>&#34;8888&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>target_tags</span>   = [<span style=color:#e6db74>&#34;bastion&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source_ranges</span> = var.<span style=color:#a6e22e>bastion_allowed_ranges</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now your cloud builder will be able to reach the control plane via the proxy just by setting proxy-url like in my
first example. The reason this works is that the bastion host resides inside our VPC and thus is available directly
from our cloud build pool.</p><script src=https://giscus.app/client.js data-repo=marcusramberg/blog data-repo-id="MDEwOlJlcG9zaXRvcnkyNzAwODc0ODA=" data-category=Announcements data-category-id=DIC_kwDOEBk1OM4CVAZX data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=transparent_dark data-lang=en crossorigin=anonymous async></script></div></div></div></article><hr><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:marcus@means.no><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-regular fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a rel=me href=https://hachyderm.io/@marcus><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-brands fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a rel=me href=https://github.com/marcusramberg><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa-brands fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted"><a href=https://github.com/marcusramberg/blog/>Code released under the MIT license.</a></p></div></div></div></footer><script src=https://marcus.means.no//js/jquery.min.js></script>
<script src=https://marcus.means.no//js/bootstrap.min.js></script></body></html>